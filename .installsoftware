#!/bin/bash

CURRENT_USER=$USER
CURRENT_USER_HOME=$(eval echo ~$USER)
SOFTWARE_FOLDER="$CURRENT_USER_HOME/software/"

createSoftwareFolder(){  
  mkdir -p $SOFTWARE_FOLDER
}

installkeycloak(){

  createSoftwareFolder

  KEYCLOAK_VERSION=17.0.0
  KEYCLOAK_FILENAME=keycloak-$KEYCLOAK_VERSION
  KEYCLOAK_ARCHIVE_NAME=$KEYCLOAK_FILENAME.tar.gz
  KEYCLOAK_ARCHIVE_PATH=$SOFTWARE_FOLDER$KEYCLOAK_FILENAME.tar.gz
  KEYCLOAK_DOWNLOAD_ADDRESS=https://github.com/keycloak/keycloak/releases/download/$KEYCLOAK_VERSION/$KEYCLOAK_ARCHIVE_NAME
  KEYCLOAK_INSTALL_DIR="/opt/keycloak"
  
  
  if [ ! -e "$KEYCLOAK_ARCHIVE_PATH" ]; then
    echo "Downloading: $KEYCLOAK_DOWNLOAD_ADDRESS..."
    echo "Download location: $KEYCLOAK_ARCHIVE_PATH"
    wget -q -P $SOFTWARE_FOLDER $KEYCLOAK_DOWNLOAD_ADDRESS
    if [ $? -ne 0 ]; then
      echo "Not possible to download Keycloak."
      exit 1
    fi
  else
    echo "Keycloak archive already exists."  
  fi

  if [ ! -d "$KEYCLOAK_INSTALL_DIR" ]; then
    sudo mkdir -p $KEYCLOAK_INSTALL_DIR
    sudo chown $CURRENT_USER:$CURRENT_USER -R $KEYCLOAK_INSTALL_DIR
  fi

  if [ ! -d "$KEYCLOAK_INSTALL_DIR/$KEYCLOAK_FILENAME" ]; then
    tar -xzf $KEYCLOAK_ARCHIVE_PATH -C $KEYCLOAK_INSTALL_DIR
  else
    echo "$KEYCLOAK_FILENAME is already installed"
  fi  

  echo ""
  echo "---------------------------------------"
  printf "\033[32mKeycloak $KEYCLOAK_VERSION installed\033[39m\n"  
  echo ""
  echo "To start Keycloak please use :"
  echo " cd $KEYCLOAK_INSTALL_DIR/$KEYCLOAK_FILENAME"
  echo " bin/kc.sh start-dev"
  echo ""
  echo "https://www.keycloak.org/getting-started/getting-started-zip#_start_keycloak"
  echo ""
  echo "---------------------------------------"

}

installwildfly(){

  createSoftwareFolder

  WILDFLY_VERSION=26.0.1.Final
  WILDFLY_FILENAME=wildfly-$WILDFLY_VERSION
  WILDFLY_ARCHIVE_NAME=$WILDFLY_FILENAME.tar.gz
  WILDFLY_ARCHIVE_PATH=$SOFTWARE_FOLDER$WILDFLY_FILENAME.tar.gz
  WILDFLY_DOWNLOAD_ADDRESS=https://github.com/wildfly/wildfly/releases/download/$WILDFLY_VERSION/$WILDFLY_ARCHIVE_NAME                           
  WILDFLY_INSTALL_DIR="/opt/wildfly"
    
  if [ ! -e "$WILDFLY_ARCHIVE_PATH" ]; then
    echo "Downloading: $WILDFLY_DOWNLOAD_ADDRESS..."
    echo "Download location: $WILDFLY_ARCHIVE_PATH"
    wget -P $SOFTWARE_FOLDER $WILDFLY_DOWNLOAD_ADDRESS
    if [ $? -ne 0 ]; then
      echo "Not possible to download Wildfly."
      exit 1
    fi
  else
    echo "Wildfly archive already exists."
  fi

  if [ ! -d "$WILDFLY_INSTALL_DIR" ]; then
    sudo mkdir -p $WILDFLY_INSTALL_DIR
    sudo chown $CURRENT_USER:$CURRENT_USER -R $WILDFLY_INSTALL_DIR
  fi

  if [ ! -d "$WILDFLY_INSTALL_DIR/$WILDFLY_FILENAME" ]; then
    tar -xzf $WILDFLY_ARCHIVE_PATH -C $WILDFLY_INSTALL_DIR
  else
    echo "$WILDFLY_FILENAME is already installed"
  fi

  echo ""
  echo "---------------------------------------"
  printf "\033[32mWildfly $WILDFLY_FILENAME installed\033[39m\n"
  echo ""
  echo "To start Wildfly please use :"
  echo " cd $WILDFLY_INSTALL_DIR/$WILDFLY_FILENAME"  
  echo " bin/standalone.sh"
  echo ""
  echo "https://github.com/jboss-developer/jboss-developer-shared-resources/blob/master/guides/START_JBOSS_EAP.adoc#start_the_jboss_eap_server"
  echo ""
  echo "---------------------------------------"

}