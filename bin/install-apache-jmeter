#!/bin/bash

# https://jmeter.apache.org/download_jmeter.cgi
# https://dlcdn.apache.org//jmeter/binaries/apache-jmeter-5.5.tgz

VERSION_JMETER=${VERSION_JMETER:=5.5}

if [ ! -z $1 ]; then
    VERSION_JMETER=$1
fi

echo "About to install Apache JMeter version : $VERSION_JMETER"

# VERSION_AVERSION_JMETER is to be found in ~.exports
JMETER_FILENAME=apache-jmeter-$VERSION_JMETER
JMETER_ARCHIVE_NAME=$JMETER_FILENAME.tgz
JMETER_ARCHIVE_PATH="$SOFTWARE_FOLDER/$JMETER_ARCHIVE_NAME"
JMETER_DOWNLOAD_ADDRESS=https://dlcdn.apache.org/jmeter/binaries/$JMETER_ARCHIVE_NAME
JMETER_INSTALL_DIR="/opt/apache/jmeter"

if [ ! -e "$JMETER_ARCHIVE_PATH" ]; then
    echo "Downloading: $JMETER_DOWNLOAD_ADDRESS..."
    echo "Download location: $JMETER_ARCHIVE_PATH"
    wget -P $SOFTWARE_FOLDER $JMETER_DOWNLOAD_ADDRESS
    wgetreturn=$?
    if [ $wgetreturn -ne 0 ]; then
        echo "Not possible to download Apache JMeter - Exit Status : $wgetreturn"
        exit 1
    fi
else
    echo "Apache JMeter archive already exists."
fi

if [ ! -d "$JMETER_INSTALL_DIR" ]; then
    udo mkdir -p $JMETER_INSTALL_DIR
    sudo chown $LOGNAME:$LOGNAME -R $JMETER_INSTALL_DIR
fi

if [ ! -d "$JMETER_INSTALL_DIR/$JMETER_FILENAME" ]; then
    echo "Do installation of $JMETER_FILENAME"
    tar -xzf $JMETER_ARCHIVE_PATH -C $JMETER_INSTALL_DIR
else
    echo "$JMETER_FILENAME is already installed"
fi